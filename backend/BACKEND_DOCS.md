# Bible Notification Project: Master Developer Guide (Backend & Integration)

> **Status**: Internal Technical Standard v1.1  
> **Target**: Frontend / Extension Developers  
> **Goal**: 100% self-service implementation of the Browser Extension.

---

## Table of Contents
1. [Project Mission & Design Intent](#1-project-mission--design-intent)
2. [Glossary of Terms](#2-glossary-of-terms)
3. [The "Adaptive Pacing" Engine (How success is guaranteed)](#3-the-adaptive-pacing-engine)
4. [Extension Lifecycle & State Machine](#4-extension-lifecycle--state-machine)
5. [Complete API Reference](#5-complete-api-reference)
   - [Bible Content (Read-Only)](#51-bible-content)
   - [Plan Management](#52-plan-management)
   - [Interaction & Progress](#53-interaction--progress)
   - [Random Mode & Feedback](#54-random-mode--feedback)
6. [Frontend Technical Requirements](#6-frontend-technical-requirements)
7. [Error Handling & Edge Cases](#7-error-handling--edge-cases)

---

## 1. Project Mission & Design Intent
This is not a "Bible App"; it is a **Notification-Driven Reading Discipline**. 
*   **Intention**: Deliver the Bible to the user during their daily work, ensuring they finish their reading plan without fail, even if they skip days.
*   **Zero Verse Loss**: If the user doesn't see a notification, those verses are **never** skipped. They are rolled into the next delivery.
*   **Consistency > Count**: We adjust the **volume** (verses per notification) rather than the **frequency** (number of interruptions).

---

## 2. Glossary of Terms
| Term | Definition |
| :--- | :--- |
| **Device ID** | A UUID generated by the extension (or returned by backend) that identifies a specific browser install. |
| **Reading Plan** | The configuration of books, target date, and frequency for a user. |
| **Reading Unit** | One "notification's worth" of verses (e.g., John 1:1-5). |
| **Quiet Hours** | User-defined time range (e.g., 22:00-06:00) where NO notifications are sent. |
| **Adaptive Pacing** | The backend calculation that increases verses per unit if the user is behind schedule. |

---

## 3. The "Adaptive Pacing" Engine
As a Frontend Developer, you don't need to do the math, but you must understand the behavior:
1.  **If the user is on track**: They get exactly `max_verses_per_unit`.
2.  **If the user misses 2 days**: The backend detects this and might increase the next unit to `max_verses_per_unit` (up to the limit) to "catch up".
3.  **If catch-up is impossible**: The API `GET /plan/calculate/{id}` will return a flag or value suggesting the plan be extended.

---

## 4. Extension Lifecycle & State Machine

### 4.1 The Background Loop (Service Worker)
Your Service Worker (`background.ts`) is the heart of the system.
1.  **Alarm**: Set a `chrome.alarms` every 15 mins.
2.  **Environment Check**:
    - Is the plan active? (Check local storage)
    - Is it Quiet Hours? (Check local settings)
    - Is the user in Fullscreen/Presentation mode? (Use `chrome.windows.getCurrent`)
3.  **Fetch**: If checks pass, call `GET /v1/plan/{deviceId}/next-unit`.
4.  **Notify**: If a unit is returned, show the notification.

### 4.2 Interaction Flow
- **User clicks "Mark Read"**: Call `PUT /v1/unit/{id}/read`. Immediately update local UI progress.
- **User clicks "Snooze"**: Set a temporary local alarm for 30m/1h/4h. Do **not** call the backend.

---

## 5. Complete API Reference

### 5.1 Bible Content
All content is from the Amharic Bible dataset.

#### `GET /v1/books`
Returns 66 Amharic book titles. Use this to populate dropdowns.
- **Example**: `["ኦሪት ዘፍጥረት", "ኦሪት ዘጸአት", ...]`

#### `GET /v1/metadata/{book_name}`
Get chapter and verse counts for UI validation.
```json
{
  "book": "ኦሪት ዘፍጥረት",
  "chapter_count": 50,
  "verse_counts": [31, 25, 24, ...] // Verses in Ch 1, Ch 2, etc.
}
```

### 5.2 Plan Management

#### `POST /v1/plan/create`
Initializes the sequence.
- **Request Body**:
```json
{
  "device_id": "uuid-string", // Optional
  "books": ["የዮሐንስ ወንጌል"],
  "target_date": "2026-12-31",
  "frequency": "daily",
  "max_verses_per_unit": 5,
  "boundaries": { // Optional: starts from midway
    "chapter_start": 1,
    "verse_start": 1
  }
}
```

#### `GET /v1/plan/calculate/{id}`
Returns the "Smart" status of the plan.
```json
{
  "remaining_verses": 450,
  "remaining_days": 12,
  "adjusted_verses_per_unit": 5, // Use this for UI "Predicted Pace"
  "next_delivery_timestamp": "2026-02-23T18:00:00Z"
}
```

### 5.3 Interaction & Progress

#### `GET /v1/plan/{id}/next-unit`
**The most important endpoint for the Extension.**
- **Response**:
```json
{
  "unit": {
    "id": "unit-uuid",
    "book": "ዮሐንስ ወንጌል",
    "chapter": 1,
    "verse_start": 1,
    "verse_end": 5,
    "text": "በመጀመሪያ ቃል ነበረ..."
  }
}
```

#### `PUT /v1/unit/{id}/read`
Call this when the user clicks the "Mark Read" button.

### 5.4 Random Mode & Feedback

#### `POST /v1/random-verse`
For the "Inspiration" mode.
- **Input**: `{"themes": ["ፍቅር", "ትዕግስት"], "time_of_day": "morning"}`

#### `POST /v1/feedback/submit`
Anonymous feedback. `{"rating": 5, "suggestion": "Love the Amharic font support!"}`

---

## 6. Frontend Technical Requirements
*   **Typography**: You **must** use `Noto Sans Ethiopic` to render the Amharic text correctly.
*   **Notification Structure**:
    *   **Title**: `{Book} {Chapter}:{v_start}-{v_end}`
    *   **Body**: The verse text payload.
    *   **Buttons**: [Mark Read] [Snooze]
*   **Storage**: Use `chrome.storage.local` to cache the current `PlanSummary` so you can show progress even when offline.

---

## 7. Error Handling & Edge Cases
*   **400 Bad Request**: Typically an invalid book name or chapter number. Show a validation error in UI.
*   **404 Not Found**: Plan ID or Unit ID is invalid. Prompt user to recreate plan.
*   **429 Too Many Requests**: Rate limit hit (100 req/min). Handle gracefully with a retry-later message.
*   **No Internet**: If the extension cannot fetch `next-unit`, it should wait for the next alarm trigger.

---
